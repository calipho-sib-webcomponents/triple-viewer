<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../evidence-item/evidence-item.html">
<link rel="import" href="../quality-label/quality-label.html">
<link rel="import" href="../shared-styles/shared-styles.html">
<script src="../feature-viewer/dist/feature-viewer.bundle.js"></script>
<script src="../sequence-viewer/dist/sequence-viewer.min.js"></script>
<script src="../nextprot/src/nextprot-core.js"></script>
<script src="../nextprot/src/nextprot-utils.js"></script>
<!--
`triple-viewer`
Complex element joining nextprot feature viewer, feature table and sequence viewer
@demo demo/index.html 
-->
<dom-module id="triple-viewer">
  <link rel="stylesheet" type="text/css" href="../feature-viewer/dist/feature-viewer.min.css">
  <template>
    <style is="custom-style" include="shared-styles">
      :host {
        display: block;
      }
      evidence-item {
        padding: 8px 0 0 0;
      }
      #featuresTable {
        font-size:11px;
        background:#fff;
        padding:5px 15px;
        height:600px;
        border: 1px solid #cfd9db;
        border-radius:4px;
      }
      #featuresTable .variant-description{
        color:#00C500;
      }
      table#featTable>tbody>tr>th {
        padding: 0 8px;
      }
      table#featTable>tbody>tr:first-of-type + tr {
        border-top: none;
      }
      table#featTable>tbody>tr {
        border-top: 1px solid #ddd;
        border-bottom: none;
      }
      table#featTable>tbody>tr>td {
        border: none;
      }
      #seqViewer ::content > .seqHeader {
        width: 100%;
      }
      #seqViewer ::content > .seqHeader > div {
        display: inline-block;
        vertical-align: top;
        text-align: center;
        width: 25%;
      }
      #seqViewer {
        background:#fff;
        padding:5px 15px;
        height:600px;
        border: 1px solid #cfd9db;
        border-radius:4px;
      }
      .seqHeader{
        margin-bottom:5px;
        border-bottom:1px solid #E7EAEC;
        height:45px;
      }
      .seqHeader>div{
        display: inline-block;
        margin:10px;
      }
      #seqViewer .seqInfos{
        display: inline-block;
        vertical-align: middle;
        font-size:11px;
        text-align: center;
        float:right;
        margin: 10px 5px 0px;
      }
      #seqViewer .seqInfos>.seqLabel{
        font-weight: 900;
        color:#777;
      }
      #seqViewer .seqInfos>.seqValue{
        color:white;
        padding:3px 5px;
        text-align: center;
        border-radius:3px;
        float:right;
      }
      #seqViewer .seqIso>.seqValue{
        background-color:#23c6c8;
      }
      #seqViewer .seqAALength>.seqValue{
        background-color:#33C59E;
        font-weight:700;
      }
      #seqViewer .seqMass>.seqValue{
        background-color:#f8ac59;
      }
      #seqViewer .seqpI>.seqValue{
        background-color:#92896F;
      }
      .evidenceNumber {
        background: #7CBA0F;
        padding: 4px 8px;
        border-radius: 2px;
        color: white;
        vertical-align: top;
        cursor: pointer;
      }
      .filter-block {
        margin:0px 20px;
        float:left;
      }
    </style>
    <div id="featureViewer">
      <div class="filter-block row">
        <div class="filter-heading">
          <span class="fa fa-filter"></span>
          <h5>FILTER</h5>
        </div>
        <div class="filter-body">
          <div id="filtering" class="all-filters">
            <button class="btn btn-default btn-sm" id="allFilters">All/None</button>
            <template is="dom-repeat" items="{{_toArray(activeFiltering.filters)}}" as="filter">
              {{filter}}
              <label class="filter-box">
                <input type="checkbox" id={{filter.name}} value="option1" checked>{{filter.value}}
              </label>
            </template>
          </div>
        </div>
      </div>
    </div>
    <div class="row" style="margin:0px 20px;">
      <div id="featuresTable" class="col-md-6" style="margin:10px 0px">
        <div id="featTableScroller" class="section-scroller">
          <table id="featTable" class="table table-striped table-fixed">
            <thead>
            <tr>
              <th class="featName" class="col-md-2">Name</th>
              <th class="col-md-2 text-align-right">Position</th>
              <th class="col-md-1 text-align-right">Length</th>
              <th class="col-md-5">Description</th>
              <th colspan="2" class="col-md-2 text-align-left">Evidence</th>
            </tr>
            </thead>
            <template is="dom-repeat" items="{{_toArray(groupedFeatures)}}" as="featureGroup">
              <tbody>
              <tr><th colspan="6" class="{{_formatClassName(featureGroup.name, featureGroup.value.group)}} general-info table-section-header"><div class="grey-x">{{featureGroup.value.group}}</div></th></tr>
              <template is="dom-repeat" items="{{featureGroup.value.features}}" as="features">
                <template is="dom-repeat" items="{{features}}" as="feature">
                  <tr id={{id}} class="{{{className category}}} general-info">
                    <td>{{feature.category}}</td>
                    <td class="text-align-right"><a class="featPosition" href="javascript:;">
                    <template is="dom-if" if="{{_isDisulfideBondFeature(feature.category)}}">
                      {{feature.start}}<span style="line-height: 0.8; vertical-align:top">&#x256d;&#x256e;</span>{{feature.end}}
                    </template>
                    <template is="dom-if" if="{{!_isDisulfideBondFeature(feature.category)}}">
                      <template is="dom-if" if="{{_isSingleResidueFeature(feature.length)}}">
                        {{feature.start}}
                      </template>
                      <template is="dom-if" if="{{!_isSingleResidueFeature(feature.length)}}">
                        {{feature.start}}-{{feature.end}}
                      </template>
                    </template>
                    </a></td>
                    <td class="text-align-right">{{feature.length}}</td>
                    <td><span inner-h-t-m-l="{{feature.link}}"></span>
                      <template is="dom-if" if="{{feature.variant}}">
                        <template is="dom-repeat" items="{{feature.source}}" as="{{source}}">
                          <template is="dom-if" if="{{source.externalDb}}">
                            <template is="dom-repeat" items="{{source.crossRef}}" as="crossRef">
                              ; {{crossRef.dbName}} : <a class='ext-link' href="{{crossRef.url}}">{{crossRef.name}}</a>
                            </template>
                          </template>
                        </template>
                      </template>
                      <template is="{{dom-if}}" if="{{!feature.proteotypicity}}">
                        <span class="nonProteotypic">found in other entries</span>
                      </template>
                      <quality-label quality="{{feature.quality}}"></quality-label>
                    </td>
                    <template is="dom-if" if="{{feature.source}}">
                      <td class="text-align-right">
                          <span id="evidences-button-{{feature.id}}" class="evidenceNumber" on-click="_toggle">{{feature.evidenceLength}}</span>
                      </td>
                      <td>
                        <div class="reference-label-container">
                          <template is="dom-repeat" items="{{feature.evidenceSources}}" as="source">
                            <div class="reference-label">{{source}}</div>
                          </template>
                        </div>
                      </td>
                    </template>
                    <template is="dom-if" if="{{!feature.source}}">
                      <td></td>
                      <td></td>
                    </template>
                  </tr>
                        <tr class="{{_formatClassName(feature.category, feature.group)}} detailed-info">
                          <td colspan="6" class="table-row-evidence" style="padding: 0 8px;">
                            <iron-collapse id="evidences-container-{{feature.id}}">
                              <template is="dom-repeat" items="{{feature.source}}" as="evidence">
                                <evidence-item index={{_increment(index)}} data="{{evidence}}"></evidence-item>
                              </template>
                            </iron-collapse>
                          </td>
                        </tr>
                </template>
              </template>
              </tbody>
            </template>
          </table>
        </div>
      </div>
      <div class="col-md-6 right-block" style="margin:10px 0px;padding-right:0px;">
        <div id="seqViewer"></div>
      </div>
    </div>
  </template>
  <script>
    Polymer({
      is: 'triple-viewer',
      properties: {
        isoform: {
          type: String
        },
        featuresByIsoform: {
          type: Array,
          value: []
        },
        featureList: {
          type: Array,
          value: [
          {
            "APIRef": "sequence",
            "metadata": {"name": "Sequence"}
          }]
        },
        featuresForViewer: {
          type: Array,
          value: []
        },
        filterOptions: {
          type: Array,
          value: {
            "none": true
          }
        },
        activeFiltering: {
          type: Array,
          value: {
            filters: {}
          }
        }
      },
      created: function() {
        this.nx = new Nextprot.Client("neXtprot triple viewer", "Calipho Group");
        this.nxEntry = this.nx.getEntryName();
        this.isoName = this.nxEntry+"-1";
        var self=this;
        this.nx.getIsoformMapping(this.nxEntry).then(
                function(data){
                  self.isoforms=data;
                  //self.isoformMapping = self.testAlgoObject(data);
                }
        ).catch(function (err) {
                  // catch any error that happened so far
                  console.log("Argh, broken: " + err.message);
                  console.log("Error at line : " + err.stack);
                });
        this.nx.getProteinSequence(this.nxEntry).then(
          function (data) {
            self.sequences = data;
            Promise.all(self.getFeaturesByView())
                    .then(function (oneData) {
                      self.getMetadataByView();
                      self.getFeaturesByIsoform(oneData);
                      self._renderFeatureViewer();
                      self.addFiltering();
                      self.addFeatures();
                      self.fillTable();
                      self.toggleFiltering();
                    });
          }
        ).catch(function (err) {
            // catch any error that happened so far
            console.log("Argh, broken: " + err.message);
            console.log("Error at line : " + err.stack);
        });
      },
      getFeaturesByIsoform: function(isoforms){
        this.isofroms=isoforms[0];
        
        for (var i=1; i<isoforms.length-1;i++) {
          var feat = NXUtils.convertMappingsToIsoformMap(isoforms[i],this.metaData[i].name,this.metaData[i].filter, "");

          this.featuresByIsoform.push(feat);
          featForViewer = NXViewerUtils.convertNXAnnotations(feat,this.metaData[i]);
          this.featuresForViewer.push(featForViewer);
        }
      },
      getFeaturesByView: function() {
        var featuresForViewer = [];
        for (var feat in this.featureList) {
          switch (this.featureList[feat].APIRef) {
            case "sequence":
              featuresForViewer.push(this.nx.getProteinSequence(this.nxEntry));
              break;
            case "antibody":
              featuresForViewer.push(this.nx.getAntibody(this.nxEntry));
              break;
            case "isoform-mapping":
              featuresForViewer.push(this.nx.getIsoformMapping(this.nxEntry));
              break;
            default:
              featuresForViewer.push(this.nx.getAnnotationsByCategory(this.nxEntry, this.featureList[feat].APIRef));
              break;
          }
        }
        return featuresForViewer;
      },
      getMetadataByView: function() {
        this.metaData = [];
        for (var i = 0; i < this.featureList.length - 1; i++) {
          this.metaData.push(this.featureList[i].metadata);
        }
      },
      addFiltering: function() {
        //console.log('adding filters');
        //var filterBlock = document.createElement("div");
        //filterBlock.setAttribute("class", "filter-block row");
        // move this style
        //filterBlock.setAttribute("style", "margin:0px 20px;float:left;");
        //this.$$("#featureViewer").insertBefore(filterBlock, this.$$(".svgHeader"));
        //this.activeFiltering = {
        //  filters: {}
        //};
        for (var i=0;i<this.featuresForViewer.length;i++) {
          //console.log(this.featuresForViewer[i]);
          if (Object.keys(this.featuresForViewer[i]).length !== 0) {
            var filter = this.featuresForViewer[i][Object.keys(this.featuresForViewer[i])[0]].filter;
            if (filter !== "none" && (!this.activeFiltering.filters[filter.split(" ").join("_")])) {
              var filterMin = filter.split(" ").join("_");
              this.activeFiltering.filters[filterMin]=filter;
              this.filterOptions[filterMin]=true;
            }
          }
        }
      },
      _renderFeatureViewer: function(){
        var self=this;
        this.sequences.forEach(function (o) {
          if (o.uniqueName === self.isoName) {
            self.currentSeq = o.sequence;
            self.ft = new FeatureViewer(self.currentSeq, "#featureViewer", {
              showAxis: true,
              showSequence: true,
              brushActive: true,
              toolbar:true,
              bubbleHelp:true,
              unit:"aa",
              zoomMax:10,
              toolbarTemplate: 2,
              positionWithoutLetter:true,
              tooltipColor:"black"
            });
            self._renderSequenceViewer(o);
          }
        });
      },
      _renderSequenceViewer: function(sequenceObject){
        seqView = new Sequence(this.currentSeq, this.isoName);
        seqView.render('#seqViewer', {
          'showLineNumbers': true,
          'wrapAminoAcids': true,
          'charsPerLine': 50,
          'search':true,
          'toolbar':true,
          'header':{
            'display':false,
            'searchInTitle': false,
            'showCpl':false,
            'badgeWithUnit':true
          }
        });
        //Customize Sequence viewer - raw version
        this.$$(".fasta-link").setAttribute("href","https://old.nextprot.org/db/entry/" + this.isoName.split("-")[0] + "/fasta?isoform=" + this.isoName.slice(3));
        var seqHeader = document.createElement("div");
        seqHeader.setAttribute("class", "seqHeader");
        this.$$("#seqViewer").insertBefore(seqHeader, this.$$(".sequenceBody"));
        var isoformContainer = document.createElement("div");
        var seqLenContainer = document.createElement("div");
        var massContainer = document.createElement("div");
        var isoElectricPointContainer = document.createElement("div");
        isoformContainer.innerHTML = "<strong>Isoform :</strong> " + sequenceObject.mainEntityName.name;
        seqLenContainer.innerHTML = sequenceObject.sequence.length + " aa";
        massContainer.innerHTML = "<strong>Mass :</strong> " + sequenceObject.massAsString + " Da";
        isoElectricPointContainer.innerHTML = "<strong>pI :</strong> " + sequenceObject.isoelectricPointAsString;
        this.$$(".seqHeader").appendChild(isoformContainer);
        this.$$(".seqHeader").appendChild(seqLenContainer);
        this.$$(".seqHeader").appendChild(massContainer);
        this.$$(".seqHeader").appendChild(isoElectricPointContainer);

        this.$$("#seqViewer .inputSearchSeq").setAttribute("placeholder","Search in sequence...");
        this.$$(".inputSearchSeq").setAttribute("data-toggle","tooltip");
        this.$$("#seqViewer .inputSearchSeq").setAttribute("data-placement","top");
        this.$$("#seqViewer .inputSearchSeq").setAttribute("title","Regex supported");

        //this.$$('#seqViewer [data-toggle="tooltip"]').tooltip();
      },
      addFeatures: function() {
        for (var i=0;i<this.featuresForViewer.length;i++) {
          if (Object.keys(this.featuresForViewer[i]).length !== 0 && this.featuresForViewer[i].hasOwnProperty(this.isoName) && this.filterOptions[this.featuresForViewer[i][this.isoName].filter.split(" ").join("_")] === true) {
            var feature = jQuery.extend({}, this.featuresForViewer[i][this.isoName]);
            this.ft.addFeature(feature);
          }
        }
      },
      fillTable: function() {
        if ($("#featuresTable").length > 0) {
          var number = 0;
          var features = {};
          var self=this;
          this.featuresByIsoform.forEach( function (d) { if (d.hasOwnProperty(self.isoName)) {
            if(d[self.isoName]) {
              var group = d[self.isoName][0].group;
              if(Object.keys(features).indexOf(group)<0) {
                features[group] = {'group': group, 'features': [d[self.isoName]]};
              } else {
                features[group]['features'].push(d[self.isoName]);
              }
            }
          }});
          for (feat in this.featuresByIsoform) if(this.featuresByIsoform[feat].hasOwnProperty(this.isoName)) {
            number += this.featuresByIsoform[feat][this.isoName].length;
            for (var i=0;i<this.featuresByIsoform[feat][this.isoName].length;i++) if(this.featuresByIsoform[feat][this.isoName][i].source) {
              this.featuresByIsoform[feat][this.isoName][i].evidenceSources = this._getUniqueListOfEvidenceSources(this.featuresByIsoform[feat][this.isoName][i].source);
            }
          }
          this.groupedFeatures = features;
          this.featuresLength = number;
        };
        $(".evidenceNumber").click(function () {
          $(this).parent().parent().next().toggle();
        })
      },
      toggleFiltering: function() {
        $("#filtering label").mouseover(function(){
          var type=$(this).children("input").attr("id");
          ft.showFilteredFeature(type, "#795B42", document.location.href);
        });
        $("#filtering label").mouseout(function(){
          var type=$(this).children("input").attr("id");
          ft.hideFilteredFeature(type);
        });
        $("#allFilters").click(function(){
          if ($("#filtering").hasClass("all-filters")){

            $("#filtering input[type=checkbox]").prop("checked", false);

            console.log("has class all-filters");
            for(var key in this.filterOptions) {
              this.filterOptions[key] = false;
            }
            $("#filtering").removeClass("all-filters");
          }
          else {

            $("#filtering input[type=checkbox]").prop("checked", true);

            for(var key in this.filterOptions) {
              this.filterOptions[key] = true;
            }
            $("#filtering").addClass("all-filters");
          }
          applyFiltering();
          getInfoForIsoform.reloadSVG(isoName);

        })
        $("#filtering input:checkbox").on("change", function() {
          console.log("count the number of checkbox not checked : ");
          console.log($("#filtering input:checkbox:not(:checked)").length);

          if (!$("#filtering input:checkbox:not(:checked)").length) {
            console.log("all checkbox are checked");
            $("#filtering").addClass("all-filters");
          }
          else if (!$("#filtering input:checkbox:checked").length) {
            console.log("all checkbox are unchecked");
            $("#filtering").removeClass("all-filters");
          }
          else {
            $("#filtering").removeClass("all-filters");
          }
          this.filterOptions["none"] = true;
          applyFiltering();
          getInfoForIsoform.reloadSVG(isoName);
        });

      },
      _getUniqueListOfEvidenceSources: function(evidenceList) {
        var evidenceSourceList = [];
        evidenceList.forEach(function(evidence){
          if(evidenceSourceList.indexOf(evidence.assignedBy) < 0) {
            evidenceSourceList.push(evidence.assignedBy);
          }
        });
        return evidenceSourceList.sort(NXUtils.sortByAlphabet);
      },
      _toArray: function(obj) {
        if (typeof obj === 'object') {
          return Object.keys(obj).map(function(key) {
            return {
              name: key,
              value: obj[key]
            };
          });
        }
        return null;
      },
      _toggle: function(mouseEvent){
        var srcElementId = mouseEvent.srcElement.id || mouseEvent.srcElement.parentNode.id;
        this.$$("#"+srcElementId.replace('button','container')).toggle();
      },
      _isDisulfideBondFeature: function(featureCategory) {
        return featureCategory === "Disulfide bond";
      },
      _isSingleResidueFeature: function(residueLength) {
        return residueLength === 1;
      },
      _formatClassName: function(name, group) {
        return name.replace(' ','')+" "+group.split(" ").join("_");
      },
      _increment: function(num) {
        return num+1;
      }
    });
  </script>
</dom-module>
