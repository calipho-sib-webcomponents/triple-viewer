<link rel="import" href="../polymer/polymer.html">
<script src="../nextprot/dist/nextprot.bundle.js"></script>
<script src="../bootstrap/dist/js/bootstrap.js"></script>
<script src="../feature-viewer/dist/feature-viewer.bundle.js"></script>
<link rel="stylesheet" type="text/css" href="../feature-viewer/dist/feature-viewer.min.css">
<script src="../sequence-viewer/dist/sequence-viewer.bundle.js"></script>
<!--
`triple-viewer`
Complex element joining nextprot feature viewer, feature table and sequence viewer
@demo demo/index.html 
-->
<dom-module id="triple-viewer">
  <template>
    <style is="custom-style">
      :host {
        display: block;
      }
      #seqViewer ::content > .seqHeader {
        width: 100%;
      }
      #seqViewer ::content > .seqHeader > div {
        display: inline-block;
        vertical-align: top;
        text-align: center;
        width: 25%;
      }
      .loading_icon {
        -webkit-animation:spin 2s linear infinite;
        -moz-animation:spin 2s linear infinite;
        animation:spin 2s linear infinite;
        width:200px;
        height:200px;
      }
      @-moz-keyframes spin { 100% {
        -moz-transform:rotate(360deg);
      } }
      @-webkit-keyframes spin { 100% {
        -webkit-transform:rotate(360deg);
      } }
      @keyframes spin { 100% {
        -webkit-transform:rotate(360deg);
        transform:rotate(360deg);
      } }
    </style>
    <div id="featureViewer"></div>
    <div class="row" style="margin:0px 20px;">
      <div id="featuresTable" class="col-md-6" style="margin:10px 0px">
        <div id="featTableScroller" class="section-scroller">
          <table id="featTable" class="table table-striped table-fixed">
            <thead>
            <tr>
              <th class="featName" class="col-md-2">Name</th>
              <th class="col-md-2 text-align-right">Position</th>
              <th class="col-md-1 text-align-right">Length</th>
              <th class="col-md-5">Description</th>
              <th colspan="2" class="col-md-2 text-align-left">Evidence</th>
            </tr>
            </thead>
            {{groupedFeatures}}
            <template is="dom-repeat" items="{{_toArray(groupedFeatures)}}" as="gf">
              {{gf.key}}
              {{gf.value}}
              <tbody>
              <th colspan="6" class="className {{gf.value.group}} general-info table-section-header"><div class="grey-x">{{gf.value.group}}</div></th>
              {{#each features}}
              {{#each this}}
              <tr id={{id}} class="{{{className category}}} general-info" >
                <td>{{category}}</td>
                <td class="text-align-right"><a class="featPosition" href="javascript:;">{{{position length}}}</a></td>
                <td class="text-align-right">{{length}}</td>
                <td>{{{link}}}{{#if variant}}{{#each source}}{{#if externalDb}}{{#if crossRef}}{{#crossRef}} ; {{dbName}} : {{{linkTo name url}}} {{/crossRef}}{{/if}}{{/if}}{{/each}}{{/if}}{{#unless proteotypicity}} <span class="nonProteotypic">found in other entries</span>{{/unless}}
                  {{> quality-label qualityQualifier=quality}}
                </td>
                {{#if source}}
                <td class="text-align-right"><span class="evidenceNumber">{{evidenceLength}}</span></td>
                <td>
                  <div class="reference-label-container">
                    {{#each evidenceSources}}
                    <div class="reference-label">{{this}}</div>
                    {{/each}}
                  </div>
                </td>
                {{else}}
                <td></td>
                <td></td>
                {{/if}}
              </tr>
              <tr class="{{{className category}}} detailed-info">
                <td colspan="6" class="table-row-evidence">
                  {{#each source}}
                  {{> evidence codeName=evidenceCodeName source=assignedBy accession=crossRef.name url=crossRef.url}}
                  <div class="{{#if publicationMD5}}evidence-publication{{/if}}">
                    {{> publication parentId=(concat id ../id)}}
                  </div>
                  {{/each}}
                </td>
              </tr>
              {{/each}}{{/each}}
              </tbody>
            </template>
          </table>
        </div>
      </div>
      <div class="col-md-6 right-block" style="margin:10px 0px;padding-right:0px;">
        <div id="seqViewer"></div>
      </div>
    </div>
  </template>
  <script>
    Polymer({
      is: 'triple-viewer',
      properties: {
        isoform: {
          type: String
        },
        featuresByIsoform: {
          type: Array,
          value: []
        },
        featureList: {
          type: Array,
          value: [
      {
        "APIRef": "sequence",
        "metadata": {"name": "Sequence"}
      },
      {
        "APIRef": "interacting-region",
        "metadata": {
          "name": "Interacting region",
          "className": "intregion",
          "color": "#B3C2F0",
          "type": "rect",
          "filter": "Region"
        }
      },
      {
        "APIRef": "miscellaneous-region",
        "metadata": {
          "name": "Region",
          "className": "miscregion",
          "color": "#B3C2B3",
          "type": "rect",
          "filter": "Region"
        }
      },
      {
        "APIRef": "domain",
        "metadata": {
          "name": "Domain",
          "className": "domain",
          "color": "#B3C2C2",
          "type": "rect",
          "filter": "Region"
        }
      },
      {
        "APIRef": "repeat",
        "metadata": {
          "name": "Repeat",
          "className": "repeat",
          "color": "#98B7D5",
          "type": "rect",
          "filter": "Region"
        }
      },
      {
        "APIRef": "calcium-binding-region",
        "metadata": {
          "name": "Calcium binding",
          "className": "calcium",
          "color": "#B3C2E1",
          "type": "rect",
          "filter": "Region"
        }
      },
      {
        "APIRef": "zinc-finger-region",
        "metadata": {
          "name": "Zinc finger",
          "className": "calcium",
          "color": "#B3C2E1",
          "type": "rect",
          "filter": "Region"
        }
      },
      {
        "APIRef": "dna-binding-region",
        "metadata": {
          "name": "DNA binding",
          "className": "dnabind",
          "color": "#B3C2FF",
          "type": "rect",
          "filter": "Region"
        }
      },
      {
        "APIRef": "nucleotide-phosphate-binding-region",
        "metadata": {
          "name": "Nucleotide binding",
          "className": "nucleobind",
          "color": "#B3D1B3",
          "type": "rect",
          "filter": "Region"
        }
      },
      {
        "APIRef": "coiled-coil-region",
        "metadata": {
          "name": "Coiled-coil",
          "className": "coiledcoil",
          "color": "#B3D1C2",
          "type": "rect",
          "filter": "Region"
        }
      },
      {
        "APIRef": "short-sequence-motif",
        "metadata": {
          "name": "Sequence motif",
          "className": "motif",
          "color": "#B3D1D1",
          "type": "rect",
          "filter": "Region"
        }
      },
      {
        "APIRef": "compositionally-biased-region",
        "metadata": {
          "name": "Composition bias",
          "className": "biased",
          "color": "#B3D1E1",
          "type": "rect",
          "filter": "Region"
        }
      },
      {
        "APIRef": "topological-domain",
        "metadata": {
          "name": "Top domain",
          "className": "topodomain",
          "color": "#A5DBA5",
          "type": "rect",
          "filter": "Topology"
        }
      },
      {
        "APIRef": "transmembrane-region",
        "metadata": {
          "name": "Membrane",
          "className": "membrane",
          "color": "#A5DBB7",
          "type": "rect",
          "filter": "Topology"
        }
      },
      {
        "APIRef": "miscellaneous-site",
        "metadata": {
          "name": "Site",
          "className": "site",
          "color": "#B3F0E1",
          "type": "unique",
          "filter": "Site"
        }
      },
      {
        "APIRef": "active-site",
        "metadata": {
          "name": "Active site",
          "className": "actSite",
          "color": "#B3F0F0",
          "type": "unique",
          "filter": "Site"
        }
      },
      {
        "APIRef": "binding-site",
        "metadata": {
          "name": "Binding site",
          "className": "bindsite",
          "color": "#82E6FF",
          "type": "unique",
          "filter": "Site"
        }
      },
      {
        "APIRef": "cleavage-site",
        "metadata": {
          "name": "Cleavage site",
          "className": "cleavsite",
          "color": "#B3FFB3",
          "type": "unique",
          "filter": "Site"
        }
      },
      {
        "APIRef": "metal-binding-site",
        "metadata": {
          "name": "Metal binding",
          "className": "metal",
          "color": "#B3FFC2",
          "type": "unique",
          "filter": "Site"
        }
      },
      {
        "APIRef": "variant",
        "metadata": {
          "name": "Variant",
          "className": "variant",
          "color": "rgba(0,255,154,0.3)",
          "type": "unique",
          "filter": "Variant"
        }
      },
      {
        "APIRef": "mutagenesis",
        "metadata": {
          "name": "Mutagenesis",
          "className": "mutagenesis",
          "color": "#73FFE3",
          "type": "unique",
          "filter": "Variant"
        }
      },
      {
        "APIRef": "sequence-conflict",
        "metadata": {
          "name": "Conflict",
          "className": "seqconflict",
          "color": "#6FFFFF",
          "type": "unique",
          "filter": "Conflict"
        }
      },
      {
        "APIRef": "beta-strand",
        "metadata": {
          "name": "Beta strand",
          "className": "betastrand",
          "color": "#B3F0C2",
          "type": "rect",
          "filter": "Secondary structure"
        }
      },
      {
        "APIRef": "helix",
        "metadata": {
          "name": "Helix",
          "className": "helix",
          "color": "#B3F0D1",
          "type": "rect",
          "filter": "Secondary structure"
        }
      },
      {
        "APIRef": "turn",
        "metadata": {
          "name": "Turn",
          "className": "turn",
          "color": "#B3F0E1",
          "type": "rect",
          "filter": "Secondary structure"
        }
      },
      {
        "APIRef": "isoform-mapping",
        "metadata": {}
      }
    ]
        },
        featuresForViewer: {
          type: Array,
          value: []
        },
        filterOptions: {
          "type": Array,
          value: {
            "none": true
          }
        }
      },
      attached: function() {
        this.nx = new Nextprot.Client("neXtprot triple viewer", "Calipho Group");
        this.nxEntry = this.nx.getEntryName();
        this.isoName = this.nxEntry+"-1";
        var self=this;
        this.nx.getIsoformMapping(this.nxEntry).then(
                function(data){
                  self.isoforms=data;
                  //self.isoformMapping = self.testAlgoObject(data);
                }
        ).catch(function (err) {
                  // catch any error that happened so far
                  console.log("Argh, broken: " + err.message);
                  console.log("Error at line : " + err.stack);
                });
        this.nx.getProteinSequence(this.nxEntry).then(
          function (data) {
            self.sequences = data;
            Promise.all(self.getFeaturesByView())
                    .then(function (oneData) {
                      self.getMetadataByView();
                      self.getFeaturesByIsoform(oneData);
                      self._renderFeatureViewer();
                      self.addFiltering();
                      self.addFeatures();
                      self.fillTable();
                      self.toggleFiltering();
                    });
          }
        );//.catch(function (err) {
            // catch any error that happened so far
        //    console.log("Argh, broken: " + err.message);
        //    console.log("Error at line : " + err.stack);
        //});
      },
      getFeaturesByIsoform: function(isoforms){
        this.isofroms=isoforms[0];
        
        for (var i=1; i<isoforms.length-1;i++) {
          var feat = NXUtils.convertMappingsToIsoformMap(isoforms[i],this.metaData[i].name,this.metaData[i].filter, "");

          this.featuresByIsoform.push(feat);
          featForViewer = NXViewerUtils.convertNXAnnotations(feat,this.metaData[i]);
          this.featuresForViewer.push(featForViewer);
        }
      },
      getFeaturesByView: function() {
        var featuresForViewer = [];
        for (var feat in this.featureList) {
          switch (this.featureList[feat].APIRef) {
            case "sequence":
              featuresForViewer.push(this.nx.getProteinSequence(this.nxEntry));
              break;
            case "antibody":
              featuresForViewer.push(this.nx.getAntibody(this.nxEntry));
              break;
            case "isoform-mapping":
              featuresForViewer.push(this.nx.getIsoformMapping(this.nxEntry));
              break;
            default:
              featuresForViewer.push(this.nx.getAnnotationsByCategory(this.nxEntry, this.featureList[feat].APIRef));
              break;
          }
        }
        return featuresForViewer;
      },
      getMetadataByView: function() {
        this.metaData = [];
        for (var i = 0; i < this.featureList.length - 1; i++) {
          this.metaData.push(this.featureList[i].metadata);
        }
      },
      addFiltering: function() {
        $("#featureViewer").append("<div class=\"filter-block\" class=\"row\" style=\"margin:0px 20px;float:left;\"></div>");
        this.activeFiltering = {
          filters: {}
        };
        for (var i=0;i<this.featuresForViewer.length;i++) {
          if (Object.keys(this.featuresForViewer[i]).length !== 0) {
            var filter = this.featuresForViewer[i][Object.keys(this.featuresForViewer[i])[0]].filter;
            if (filter !== "none" && (!this.activeFiltering.filters[filter.split(" ").join("_")])) {
              var filterMin = filter.split(" ").join("_");
              this.activeFiltering.filters[filterMin]=filter;
              this.filterOptions[filterMin]=true;
            }
          }
        }
      },
      _renderFeatureViewer: function(){
        var self=this;
        this.sequences.forEach(function (o) {
          if (o.uniqueName === self.isoName) {
            self.currentSeq = o.sequence;
            self.ft = new FeatureViewer(self.currentSeq, "#featureViewer", {
              showAxis: true,
              showSequence: true,
              brushActive: true,
              toolbar:true,
              bubbleHelp:true,
              unit:"aa",
              zoomMax:10,
              toolbarTemplate: 2,
              positionWithoutLetter:true,
              tooltipColor:"black"
            });
            self._renderSequenceViewer(o);
          }
        });
      },
      _renderSequenceViewer: function(sequenceObject){
        seqView = new Sequence(this.currentSeq, this.isoName);
        seqView.render('#seqViewer', {
          'showLineNumbers': true,
          'wrapAminoAcids': true,
          'charsPerLine': 50,
          'search':true,
          'toolbar':true,
          'header':{
            'display':false,
            'searchInTitle': false,
            'showCpl':false,
            'badgeWithUnit':true
          }
        });
        //Customize Sequence viewer - raw version
        this.$$(".fasta-link").setAttribute("href","https://old.nextprot.org/db/entry/" + this.isoName.split("-")[0] + "/fasta?isoform=" + this.isoName.slice(3));
        var seqHeader = document.createElement("div");
        seqHeader.setAttribute("class", "seqHeader");
        this.$$("#seqViewer").insertBefore(seqHeader, this.$$(".sequenceBody"));
        var isoformContainer = document.createElement("div");
        var seqLenContainer = document.createElement("div");
        var massContainer = document.createElement("div");
        var isoElectricPointContainer = document.createElement("div");
        isoformContainer.innerHTML = "<strong>Isoform :</strong> " + sequenceObject.mainEntityName.name;
        seqLenContainer.innerHTML = sequenceObject.sequence.length + " aa";
        massContainer.innerHTML = "<strong>Mass :</strong> " + sequenceObject.massAsString + " Da";
        isoElectricPointContainer.innerHTML = "<strong>pI :</strong> " + sequenceObject.isoelectricPointAsString;
        this.$$(".seqHeader").appendChild(isoformContainer);
        this.$$(".seqHeader").appendChild(seqLenContainer);
        this.$$(".seqHeader").appendChild(massContainer);
        this.$$(".seqHeader").appendChild(isoElectricPointContainer);

        this.$$("#seqViewer .inputSearchSeq").setAttribute("placeholder","Search in sequence...");
        this.$$(".inputSearchSeq").setAttribute("data-toggle","tooltip");
        this.$$("#seqViewer .inputSearchSeq").setAttribute("data-placement","top");
        this.$$("#seqViewer .inputSearchSeq").setAttribute("title","Regex supported");

        //this.$$('#seqViewer [data-toggle="tooltip"]').tooltip();
      },
      addFeatures: function() {
        for (var i=0;i<this.featuresForViewer.length;i++) {
          if (Object.keys(this.featuresForViewer[i]).length !== 0 && this.featuresForViewer[i].hasOwnProperty(this.isoName) && this.filterOptions[this.featuresForViewer[i][this.isoName].filter.split(" ").join("_")] === true) {
            var feature = jQuery.extend({}, this.featuresForViewer[i][this.isoName]);
            this.ft.addFeature(feature);
          }
        }
      },
      fillTable: function() {
        if (this.$$("#featuresTable").length > 0) {
          var number = 0;
          var features = {};
          this.featuresByIsoform.forEach( function (d) { if (d.hasOwnProperty(this.isoName)) {
            if(d[this.isoName]) {
              var group = d[this.isoName][0].group;
              if(Object.keys(features).indexOf(group)<0) {
                features[group] = {'group': group, 'features': [d[this.isoName]]};
              } else {
                features[group]['features'].push(d[this.isoName]);
              }
            }
          }});
          console.log(features);
          for (feat in this.featuresByIsoform) if(this.featuresByIsoform[feat].hasOwnProperty(this.isoName)) {
            number += this.featuresByIsoform[feat][this.isoName].length;
            for (var i=0;i<this.featuresByIsoform[feat][this.isoName].length;i++) if(this.featuresByIsoform[feat][this.isoName][i].source) {
              this.featuresByIsoform[feat][this.isoName][i].evidenceSources = this._getUniqueListOfEvidenceSources(this.featuresByIsoform[feat][this.isoName][i].source);
            }
          }
          this.groupedFeatures = features;
          console.log(this.groupedFeatures);
          this.featuresLength = number;
        };
        $(".evidenceNumber").click(function () {
          $(this).parent().parent().next().toggle();
        })
      },
      toggleFiltering: function() {
        $("#filtering label").mouseover(function(){
          var type=$(this).children("input").attr("id");
          ft.showFilteredFeature(type, "#795B42", document.location.href);
        });
        $("#filtering label").mouseout(function(){
          var type=$(this).children("input").attr("id");
          ft.hideFilteredFeature(type);
        });
        $("#allFilters").click(function(){
          if ($("#filtering").hasClass("all-filters")){

            $("#filtering input[type=checkbox]").prop("checked", false);

            console.log("has class all-filters");
            for(var key in this.filterOptions) {
              this.filterOptions[key] = false;
            }
            $("#filtering").removeClass("all-filters");
          }
          else {

            $("#filtering input[type=checkbox]").prop("checked", true);

            for(var key in this.filterOptions) {
              this.filterOptions[key] = true;
            }
            $("#filtering").addClass("all-filters");
          }
          applyFiltering();
          getInfoForIsoform.reloadSVG(isoName);

        })
        $("#filtering input:checkbox").on("change", function() {
          console.log("count the number of checkbox not checked : ");
          console.log($("#filtering input:checkbox:not(:checked)").length);

          if (!$("#filtering input:checkbox:not(:checked)").length) {
            console.log("all checkbox are checked");
            $("#filtering").addClass("all-filters");
          }
          else if (!$("#filtering input:checkbox:checked").length) {
            console.log("all checkbox are unchecked");
            $("#filtering").removeClass("all-filters");
          }
          else {
            $("#filtering").removeClass("all-filters");
          }
          this.filterOptions["none"] = true;
          applyFiltering();
          getInfoForIsoform.reloadSVG(isoName);
        });

      },
      _getUniqueListOfEvidenceSources: function(evidenceList){
        var evidenceSourceList = [];
        evidenceList.forEach(function(evidence){
          if(evidenceSourceList.indexOf(evidence.assignedBy) < 0) {
            evidenceSourceList.push(evidence.assignedBy);
          }
        });
        return evidenceSourceList.sort(NXUtils.sortByAlphabet);
      },
      _toArray: function(obj) {
        if (typeof obj === 'object') {
          return Object.keys(obj).map(function(key) {
            return {
              name: key,
              value: obj[key]
            };
          });
        }
        return null;
      }
    });
  </script>
</dom-module>
